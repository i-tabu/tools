<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Rotator App</title>
  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f8f9fa;
      padding: 2rem;
    }
    .image-area {
      border: 2px dashed #6c757d;
      padding: 1rem;
      border-radius: 12px;
      background: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 400px;
      overflow: hidden;
    }
    canvas {
      max-width: 100%;
      max-height: 100%;
    }
  </style>
</head>
<body>
  <div class="container text-center">
    <h1 class="mb-4">🖼️ Image Rotator</h1>

    <!-- Upload -->
    <div class="mb-3">
      <input class="form-control" type="file" id="uploadImage" accept="image/*">
    </div>

    <!-- Image Area -->
    <div class="image-area mb-3">
      <canvas id="canvas"></canvas>
    </div>

    <!-- Controls -->
    <div class="d-flex justify-content-center align-items-center gap-3 flex-wrap mb-3">
      <button class="btn btn-outline-primary" id="rotateLeft">⟲ Rotate Left</button>
      <button class="btn btn-outline-secondary" id="flipHorizontal">⇆ Flip H</button>
      <button class="btn btn-outline-secondary" id="flipVertical">⇅ Flip V</button>
      <input type="range" id="rotateSlider" min="-180" max="180" value="0" step="1" class="form-range w-50">
      <button class="btn btn-outline-primary" id="rotateRight">⟳ Rotate Right</button>
    </div>

    <!-- Actions -->
    <div class="d-flex justify-content-center gap-3">
      <button class="btn btn-warning" id="cropBtn">✂️ Crop</button>
      <button class="btn btn-success" id="downloadBtn">💾 Save & Download</button>
    </div>
  </div>

  <script>
    const uploadImage = document.getElementById("uploadImage");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const rotateLeft = document.getElementById("rotateLeft");
    const rotateRight = document.getElementById("rotateRight");
    const rotateSlider = document.getElementById("rotateSlider");
    const flipHorizontal = document.getElementById("flipHorizontal");
    const flipVertical = document.getElementById("flipVertical");
    const cropBtn = document.getElementById("cropBtn");
    const downloadBtn = document.getElementById("downloadBtn");

    let img = new Image();
    let angle = 0;
    let flipH = false;
    let flipV = false;
    let isCropping = false;
    let startX = 0;
    let startY = 0;
    let isDrawing = false;

    // Upload image
    uploadImage.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          img = new Image();
          img.onload = () => {
            angle = 0;
            rotateSlider.value = 0;
            drawImage();
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    // Draw rotated image
    function drawImage() {
      if (!img.src) return;
      const radians = angle * Math.PI / 180;
      const w = img.width;
      const h = img.height;

      // Calculate new canvas size
      const cos = Math.abs(Math.cos(radians));
      const sin = Math.abs(Math.sin(radians));
      canvas.width = w * cos + h * sin;
      canvas.height = w * sin + h * cos;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.translate(canvas.width / 2, canvas.height / 2);
      ctx.rotate(radians);
      ctx.scale(flipH ? -1 : 1, flipV ? -1 : 1);
      ctx.drawImage(img, -w / 2, -h / 2);
      ctx.restore();
    }

    // Rotate Left
    rotateLeft.addEventListener("click", () => {
      angle -= 90;
      rotateSlider.value = angle;
      drawImage();
    });

    // Rotate Right
    rotateRight.addEventListener("click", () => {
      angle += 90;
      rotateSlider.value = angle;
      drawImage();
    });

    // Slider precise rotation
    rotateSlider.addEventListener("input", (e) => {
      angle = parseInt(e.target.value);
      drawImage();
    });

    // Flip horizontally
    flipHorizontal.addEventListener("click", () => {
      flipH = !flipH;
      drawImage();
    });

    // Flip vertically
    flipVertical.addEventListener("click", () => {
      flipV = !flipV;
      drawImage();
    });

    // Crop functionality
    cropBtn.addEventListener("click", () => {
      if (!img.src) return;
      isCropping = !isCropping;
      cropBtn.textContent = isCropping ? "Cancel Crop" : "✂️ Crop";
      if (!isCropping) drawImage();
    });

    canvas.addEventListener("mousedown", (e) => {
      if (!isCropping) return;
      const rect = canvas.getBoundingClientRect();
      startX = e.clientX - rect.left;
      startY = e.clientY - rect.top;
      isDrawing = true;
    });

    canvas.addEventListener("mousemove", (e) => {
      if (!isCropping || !isDrawing) return;
      const rect = canvas.getBoundingClientRect();
      const currentX = e.clientX - rect.left;
      const currentY = e.clientY - rect.top;
      drawImage();
      ctx.strokeStyle = "red";
      ctx.lineWidth = 2;
      ctx.setLineDash([6]);
      ctx.strokeRect(startX, startY, currentX - startX, currentY - startY);
      ctx.setLineDash([]);
    });

    canvas.addEventListener("mouseup", (e) => {
      if (!isCropping || !isDrawing) return;
      const rect = canvas.getBoundingClientRect();
      const endX = e.clientX - rect.left;
      const endY = e.clientY - rect.top;
      const x = Math.min(startX, endX);
      const y = Math.min(startY, endY);
      const w = Math.abs(endX - startX);
      const h = Math.abs(endY - startY);
      drawImage();
      if (w && h) {
        const tempCanvas = document.createElement("canvas");
        tempCanvas.width = w;
        tempCanvas.height = h;
        tempCanvas.getContext("2d").drawImage(canvas, x, y, w, h, 0, 0, w, h);
        img = new Image();
        img.onload = () => {
          angle = 0;
          rotateSlider.value = 0;
          flipH = false;
          flipV = false;
          canvas.width = w;
          canvas.height = h;
          drawImage();
        };
        img.src = tempCanvas.toDataURL();
      }
      isCropping = false;
      isDrawing = false;
      cropBtn.textContent = "✂️ Crop";
    });

    // Download rotated image
    downloadBtn.addEventListener("click", () => {
      if (!img.src) return;
      const link = document.createElement("a");
      link.download = "rotated-image.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    });
  </script>
</body>
</html>
